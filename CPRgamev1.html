<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPR Training Game</title>
    <style>
        :root {
            --primary: #e74c3c;
            --secondary: #3498db;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #c0392b;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: var(--dark);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        p.subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .level-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: var(--primary);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        .timer-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }
        
        .timer {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--dark);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: conic-gradient(var(--primary) 0%, transparent 0%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .timer::before {
            content: '';
            position: absolute;
            width: 130px;
            height: 130px;
            background-color: white;
            border-radius: 50%;
        }
        
        .timer span {
            position: relative;
            z-index: 1;
        }
        
        .actions {
            display: flex;
            justify-content: space-around;
            margin: 40px 0;
            flex-wrap: wrap;
        }
        
        .action {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 0 15px;
            user-select: none;
        }
        
        .action:active {
            transform: scale(0.9);
        }
        
        .action-icon {
            font-size: 5rem;
            margin-bottom: 10px;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .heart-icon {
            background-color: var(--primary);
            color: white;
        }
        
        .heart-icon.active {
            animation: heartbeat 0.3s ease-out;
        }
        
        .lung-icon {
            background-color: var(--secondary);
            color: white;
        }
        
        .lung-icon.active {
            animation: breathe 1s ease-in-out;
        }
        
        .feedback {
            position: absolute;
            font-size: 0.8rem;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 15px;
            color: white;
            opacity: 0;
            transition: opacity 0.3s;
            top: 5px;
        }
        
        .feedback.visible {
            opacity: 1;
        }
        
        .good {
            background-color: var(--success);
        }
        
        .warning {
            background-color: var(--warning);
        }
        
        .bad {
            background-color: var(--danger);
        }
        
        .action-label {
            font-weight: bold;
            color: var(--dark);
            font-size: 1.2rem;
        }
        
        .metrics {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            text-align: center;
            flex-wrap: wrap;
        }
        
        .metric {
            padding: 15px;
            border-radius: 10px;
            background-color: rgba(236, 240, 241, 0.7);
            margin: 5px;
            width: 180px;
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--dark);
        }
        
        .start-screen, .results-screen, .level-intro-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            z-index: 10;
            text-align: center;
        }
        
        .hide {
            display: none;
        }
        
        .btn {
            padding: 12px 30px;
            border-radius: 30px;
            background-color: var(--primary);
            color: white;
            font-weight: bold;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            margin-top: 20px;
            outline: none;
        }
        
        .btn:hover {
            background-color: var(--danger);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: none;
        }
        
        .instructions {
            margin: 20px 0;
            background-color: rgba(236, 240, 241, 0.7);
            padding: 20px;
            border-radius: 10px;
            max-width: 600px;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .instructions li {
            margin-bottom: 10px;
            text-align: left;
        }
        
        .progress-container {
            width: 100%;
            height: 10px;
            background-color: rgba(236, 240, 241, 0.7);
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            width: 0;
            background-color: var(--primary);
            transition: width 0.1s;
        }
        
        .cycle-indicator {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 400px;
            margin-bottom: 30px;
        }
        
        .cycle-step {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #999;
            position: relative;
        }
        
        .cycle-step.active {
            background-color: var(--primary);
            color: white;
        }
        
        .cycle-step::after {
            content: '';
            position: absolute;
            width: 30px;
            height: 2px;
            background-color: #ddd;
            top: 50%;
            left: 100%;
            transform: translateY(-50%);
        }
        
        .cycle-step:last-child::after {
            display: none;
        }
        
        .results-title {
            font-size: 2rem;
            margin-bottom: 20px;
            color: var(--dark);
        }
        
        .results-summary {
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: var(--light);
            margin: 20px 0 40px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .results-percentage {
            font-size: 3rem;
            font-weight: bold;
            position: relative;
            z-index: 1;
        }
        
        .results-circle {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--primary) 0%, transparent 0%);
            transition: background 1s ease;
        }
        
        .results-circle::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border-radius: 50%;
            background-color: white;
        }
        
        .results-details {
            background-color: var(--light);
            padding: 20px;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .result-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .result-label {
            font-weight: bold;
            color: var(--dark);
        }
        
        .result-value {
            display: flex;
            align-items: center;
        }
        
        .result-icon {
            margin-left: 5px;
            font-size: 1.2rem;
        }
        
        .green {
            color: var(--success);
        }
        
        .orange {
            color: var(--warning);
        }
        
        .red {
            color: var(--danger);
        }
        
        .results-message {
            margin-top: 30px;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--dark);
        }
        
        .level-progress {
            display: flex;
            justify-content: space-between;
            margin: 30px 0;
            width: 100%;
            max-width: 400px;
        }
        
        .level-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100px;
            position: relative;
        }
        
        .level-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 25px;
            right: -20px;
            width: 40px;
            height: 2px;
            background-color: #ddd;
        }
        
        .level-step.completed:not(:last-child)::after {
            background-color: var(--success);
        }
        
        .level-step.current:not(:last-child)::after {
            background-color: var(--primary);
        }
        
        .level-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
            margin-bottom: 10px;
        }
        
        .level-step.completed .level-circle {
            background-color: var(--success);
        }
        
        .level-step.current .level-circle {
            background-color: var(--primary);
        }
        
        .level-text {
            font-size: 0.9rem;
            color: #7f8c8d;
            text-align: center;
        }
        
        .level-step.completed .level-text,
        .level-step.current .level-text {
            color: var(--dark);
            font-weight: bold;
        }
        
        .level-threshold {
            font-size: 0.8rem;
            color: #95a5a6;
            margin-top: 5px;
        }
        
        .level-intro {
            text-align: center;
            margin: 20px 0;
        }
        
        .level-intro h2 {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .level-intro p {
            font-size: 1.2rem;
            color: var(--dark);
            margin-bottom: 20px;
        }
        
        .level-requirements {
            background-color: rgba(236, 240, 241, 0.7);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: left;
        }
        
        .level-requirements h3 {
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .trophy {
            font-size: 5rem;
            color: gold;
            margin-bottom: 20px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        @keyframes heartbeat {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(0.8);
            }
            100% {
                transform: scale(1);
            }
        }
        
        @keyframes breathe {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }
        
        @media (max-width: 600px) {
            h1 {
                font-size: 2rem;
            }
            
            .container {
                padding: 20px;
            }
            
            .actions {
                flex-direction: column;
                align-items: center;
            }
            
            .action {
                margin-bottom: 20px;
            }
            
            .timer {
                width: 120px;
                height: 120px;
                font-size: 2rem;
            }
            
            .timer::before {
                width: 100px;
                height: 100px;
            }
            
            .metrics {
                flex-direction: column;
                align-items: center;
            }
            
            .metric {
                margin-bottom: 10px;
                width: 100%;
            }
            
            .action-icon {
                width: 100px;
                height: 100px;
                font-size: 4rem;
            }
            
            .level-progress {
                width: 100%;
            }
            
            .level-step {
                width: 80px;
            }
            
            .level-circle {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .level-text, .level-threshold {
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>CPR Training Game</h1>
            <p class="subtitle">Practice your chest compression and ventilation skills (1-minute session)</p>
        </header>
        
        <div class="level-badge" id="levelBadge">Level 1</div>
        
        <div class="timer-container">
            <div class="timer">
                <span id="time">1:00</span>
            </div>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="cycle-indicator">
            <div class="cycle-step active" data-step="compressions">
                <span>C</span>
            </div>
            <div class="cycle-step" data-step="ventilations">
                <span>V</span>
            </div>
        </div>
        
        <div class="metrics">
            <div class="metric">
                <div class="metric-label">COMPRESSION RATE</div>
                <div class="metric-value" id="compressionRate">0/min</div>
            </div>
            <div class="metric">
                <div class="metric-label">VENTILATION TIME</div>
                <div class="metric-value" id="ventilationTime">0.0s</div>
            </div>
            <div class="metric">
                <div class="metric-label">COMPRESSION COUNT</div>
                <div class="metric-value" id="compressionCount">0/30</div>
            </div>
        </div>
        
        <div class="actions">
            <div class="action" id="compressionAction">
                <div class="action-icon heart-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="60" height="60">
                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                    </svg>
                    <div class="feedback" id="compressionFeedback"></div>
                </div>
                <div class="action-label">COMPRESS</div>
            </div>
            
            <div class="action" id="ventilationAction">
                <div class="action-icon lung-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="60" height="60">
                        <path d="M8.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm11.5 4c0-2.21-1.79-4-4-4s-4 1.79-4 4c0 .5.1.98.27 1.43l-2.02 7.92c-.07.27-.25.48-.49.57-.24.09-.52.05-.73-.11l-1.92-1.44c-.31-.23-.71-.29-1.08-.17-.37.13-.65.46-.7.85l-.22 1.76c-.06.52.29 1.01.8 1.13L9 21h7v-4.01c0-.5-.27-.96-.7-1.21l-5.3-3.07 1.5-5.94C12.98 10.19 16 9.84 16 13v.5c0 .28.22.5.5.5s.5-.22.5-.5V13c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55.45-1 1-1s1 .45 1 1v3z"/>
                    </svg>
                    <div class="feedback" id="ventilationFeedback"></div>
                </div>
                <div class="action-label">VENTILATE</div>
            </div>
        </div>
        
        <div class="start-screen" id="startScreen">
            <h2>Welcome to CPR Training Game</h2>
            
            <div class="level-progress">
                <div class="level-step current" data-level="1">
                    <div class="level-circle">1</div>
                    <div class="level-text">Basic</div>
                    <div class="level-threshold">70%</div>
                </div>
                <div class="level-step" data-level="2">
                    <div class="level-circle">2</div>
                    <div class="level-text">Advanced</div>
                    <div class="level-threshold">85%</div>
                </div>
                <div class="level-step" data-level="3">
                    <div class="level-circle">3</div>
                    <div class="level-text">Expert</div>
                    <div class="level-threshold">95%</div>
                </div>
            </div>
            
            <div class="instructions">
                <h3>How to play:</h3>
                <ol>
                    <li><strong>Chest Compressions:</strong> Tap the heart icon 30 times at a rate of 100-110 compressions per minute.</li>
                    <li><strong>Rescue Breaths:</strong> Press and hold the lung icon for exactly 1 second, twice.</li>
                    <li>Continue alternating between compressions and breaths for the full 1-minute session.</li>
                    <li>Try to maintain the correct rhythm and timing for the best score!</li>
                    <li>Score at least 70% to advance to Level 2, 85% for Level 3, and 95% to win the game.</li>
                </ol>
            </div>
            <button class="btn" id="startButton">START TRAINING</button>
        </div>
        
        <div class="level-intro-screen hide" id="levelIntroScreen">
            <div class="level-intro">
                <h2 id="levelIntroTitle">Level 1: Basic CPR</h2>
                <p id="levelIntroDescription">Master the basics of effective CPR technique.</p>
            </div>
            
            <div class="level-requirements">
                <h3>Level Requirements:</h3>
                <ul id="levelRequirements">
                    <li>Achieve a compression rate of 100-110/min</li>
                    <li>Maintain ventilation time of 1 second</li>
                    <li>Complete at least 3 full CPR cycles</li>
                    <li>Score at least 70% to advance to Level 2</li>
                </ul>
            </div>
            
            <button class="btn" id="levelStartButton">START LEVEL</button>
        </div>
        
        <div class="results-screen hide" id="resultsScreen">
            <h2 class="results-title" id="resultsTitle">Level 1 Complete</h2>
            
            <div class="results-summary">
                <div class="results-percentage" id="overallScore">0%</div>
                <div class="results-circle" id="resultsCircle"></div>
            </div>
            
            <div class="results-details">
                <div class="result-item">
                    <div class="result-label">Average Compression Rate:</div>
                    <div class="result-value">
                        <span id="finalCompressionRate">0/min</span>
                        <span class="result-icon" id="compressionRateIcon">⬤</span>
                    </div>
                </div>
                
                <div class="result-item">
                    <div class="result-label">Average Ventilation Time:</div>
                    <div class="result-value">
                        <span id="finalVentilationTime">0.0s</span>
                        <span class="result-icon" id="ventilationTimeIcon">⬤</span>
                    </div>
                </div>
                
                <div class="result-item">
                    <div class="result-label">Total Cycles Completed:</div>
                    <div class="result-value" id="totalCycles">0</div>
                </div>
            </div>
            
            <div class="results-message" id="feedbackMessage"></div>
            
            <div id="nextLevelActions">
                <button class="btn" id="nextLevelButton">NEXT LEVEL</button>
            </div>
            <button class="btn" id="retryLevelButton">RETRY LEVEL</button>
            <button class="btn" id="backToStartButton">BACK TO MENU</button>
        </div>
    </div>

    <script>
        // Game state variables
let gameActive = false;
let gameMode = 'compressions';
let secondsRemaining = 60;
let compressionCount = 0;
let ventilationCount = 0;
let cycleCount = 0;
let lastCompressionTime = 0;
let ventilationStartTime = 0;
let ventilationHoldTimes = [];
let compressionTimes = [];
let gameInterval;
let isPaused = false;
let pausedRemainingTime = 0;

// High score tracking
let highScores = {
    level1: 0,
    level2: 0,
    level3: 0
};

// Level configuration
let currentLevel = 1;
const levelThresholds = {
    1: 70,
    2: 85,
    3: 95
};

const levelDetails = {
    1: {
        title: "Level 1: Basic CPR",
        description: "Master the basics of effective CPR technique.",
        requirements: [
            "Achieve a compression rate of 100-110/min",
            "Maintain ventilation time of 1 second",
            "Complete at least 3 full CPR cycles",
            "Score at least 70% to advance to Level 2"
        ]
    },
    2: {
        title: "Level 2: Advanced CPR",
        description: "Fine-tune your technique for more precise CPR.",
        requirements: [
            "Achieve a compression rate of 103-107/min",
            "Maintain ventilation time of 0.9-1.1 seconds",
            "Complete at least 4 full CPR cycles",
            "Score at least 85% to advance to Level 3"
        ]
    },
    3: {
        title: "Level 3: Expert CPR",
        description: "Perfect your CPR technique to expert standards.",
        requirements: [
            "Achieve a compression rate of exactly 105/min",
            "Maintain ventilation time of exactly 1 second",
            "Complete at least 5 full CPR cycles",
            "Score at least 95% to become a CPR master"
        ]
    }
};

// Audio variables
let audioContext;
let compressionSound;
let ventilationSound;
let successSound;
let failSound;

// Get DOM elements
const timeDisplay = document.getElementById('time');
const progressBar = document.getElementById('progressBar');
const compressionRateDisplay = document.getElementById('compressionRate');
const ventilationTimeDisplay = document.getElementById('ventilationTime');
const compressionCountDisplay = document.getElementById('compressionCount');
const compressionAction = document.getElementById('compressionAction');
const ventilationAction = document.getElementById('ventilationAction');
const compressionIcon = compressionAction.querySelector('.action-icon');
const ventilationIcon = ventilationAction.querySelector('.action-icon');
const compressionFeedback = document.getElementById('compressionFeedback');
const ventilationFeedback = document.getElementById('ventilationFeedback');
const startScreen = document.getElementById('startScreen');
const resultsScreen = document.getElementById('resultsScreen');
const levelIntroScreen = document.getElementById('levelIntroScreen');
const startButton = document.getElementById('startButton');
const levelStartButton = document.getElementById('levelStartButton');
const nextLevelButton = document.getElementById('nextLevelButton');
const retryLevelButton = document.getElementById('retryLevelButton');
const backToStartButton = document.getElementById('backToStartButton');
const overallScore = document.getElementById('overallScore');
const resultsCircle = document.getElementById('resultsCircle');
const finalCompressionRate = document.getElementById('finalCompressionRate');
const finalVentilationTime = document.getElementById('finalVentilationTime');
const totalCycles = document.getElementById('totalCycles');
const compressionRateIcon = document.getElementById('compressionRateIcon');
const ventilationTimeIcon = document.getElementById('ventilationTimeIcon');
const feedbackMessage = document.getElementById('feedbackMessage');
const cycleSteps = document.querySelectorAll('.cycle-step');
const levelBadge = document.getElementById('levelBadge');
const resultsTitle = document.getElementById('resultsTitle');
const levelIntroTitle = document.getElementById('levelIntroTitle');
const levelIntroDescription = document.getElementById('levelIntroDescription');
const levelRequirements = document.getElementById('levelRequirements');
const levelSteps = document.querySelectorAll('.level-step');
const nextLevelActions = document.getElementById('nextLevelActions');

// Initialize the game
function initGame() {
    // Set up event listeners
    startButton.addEventListener('click', showLevelIntro);
    levelStartButton.addEventListener('click', startGame);
    nextLevelButton.addEventListener('click', goToNextLevel);
    retryLevelButton.addEventListener('click', restartLevel);
    backToStartButton.addEventListener('click', backToStart);
    compressionAction.addEventListener('click', handleCompression);
    
    // Enhance touch events for mobile devices
    ventilationAction.addEventListener('mousedown', startVentilation);
    ventilationAction.addEventListener('mouseup', endVentilation);
    ventilationAction.addEventListener('mouseleave', endVentilation); // In case cursor moves out
    ventilationAction.addEventListener('touchstart', (e) => {
        e.preventDefault(); // Prevent default touch behavior
        startVentilation(e);
    });
    ventilationAction.addEventListener('touchend', (e) => {
        e.preventDefault(); // Prevent default touch behavior
        endVentilation();
    });
    ventilationAction.addEventListener('touchcancel', endVentilation);
    
    updateLevelProgress();
    
    ventilationAction.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        return false;
    });
    
    // Add pause/resume functionality
    document.addEventListener('keydown', (e) => {
        if (e.key === 'p' || e.key === 'P') {
            togglePause();
        }
    });
    
    // Add keyboard controls
    addKeyboardControls();
    
    // Initialize audio
    initAudio();
    
    // Load high scores
    loadHighScores();
    
    // Add a fade-in animation to the start screen
    startScreen.style.opacity = '0';
    startScreen.style.transition = 'opacity 0.5s ease-in-out';
    setTimeout(() => {
        startScreen.style.opacity = '1';
    }, 100);
}

// Show the level introduction screen
function showLevelIntro() {
    startScreen.classList.add('hide');
    
    levelIntroTitle.textContent = levelDetails[currentLevel].title;
    levelIntroDescription.textContent = levelDetails[currentLevel].description;
    
    levelRequirements.innerHTML = '';
    
    levelDetails[currentLevel].requirements.forEach(req => {
        const li = document.createElement('li');
        li.textContent = req;
        levelRequirements.appendChild(li);
    });
    
    levelIntroScreen.classList.remove('hide');
}

// Start the game
function startGame() {
    gameActive = true;
    levelIntroScreen.classList.add('hide');
    levelBadge.textContent = `Level ${currentLevel}`;
    gameMode = 'compressions';
    updateCycleIndicator();
    
    secondsRemaining = 60;
    compressionCount = 0;
    ventilationCount = 0;
    cycleCount = 0;
    lastCompressionTime = 0;
    ventilationHoldTimes = [];
    compressionTimes = [];
    
    timeDisplay.textContent = '1:00';
    compressionRateDisplay.textContent = '0/min';
    ventilationTimeDisplay.textContent = '0.0s';
    compressionCountDisplay.textContent = '0/30';
    
    gameInterval = setInterval(() => {
        secondsRemaining--;
        
        const minutes = Math.floor(secondsRemaining / 60);
        const seconds = secondsRemaining % 60;
        timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        const progressPercent = ((60 - secondsRemaining) / 60) * 100;
        document.querySelector('.timer').style.background = 
            `conic-gradient(var(--primary) ${progressPercent}%, transparent ${progressPercent}%)`;
        
        progressBar.style.width = `${progressPercent}%`;
        
        if (secondsRemaining <= 0) {
            enhancedEndGame();
        }
    }, 1000);
}

// End the game
function endGame() {
    gameActive = false;
    clearInterval(gameInterval);
    
    const compressionRateScore = calculateCompressionRateScore();
    const ventilationTimeScore = calculateVentilationTimeScore();
    
    const overall = Math.round(compressionRateScore + ventilationTimeScore);
    
    resultsTitle.textContent = `Level ${currentLevel} Complete`;
    finalCompressionRate.textContent = `${calculateAverageCompressionRate()}/min`;
    finalVentilationTime.textContent = `${calculateAverageVentilationTime().toFixed(2)}s`;
    totalCycles.textContent = cycleCount;
    overallScore.textContent = `${overall}%`;
    
    if (compressionRateScore >= 45) {
        compressionRateIcon.className = 'result-icon green';
    } else if (compressionRateScore >= 35) {
        compressionRateIcon.className = 'result-icon orange';
    } else {
        compressionRateIcon.className = 'result-icon red';
    }
    
    if (ventilationTimeScore >= 45) {
        ventilationTimeIcon.className = 'result-icon green';
    } else if (ventilationTimeScore >= 35) {
        ventilationTimeIcon.className = 'result-icon orange';
    } else {
        ventilationTimeIcon.className = 'result-icon red';
    }
    
    const levelThreshold = levelThresholds[currentLevel];
    
    if (overall >= levelThreshold) {
        if (currentLevel === 3) {
            feedbackMessage.innerHTML = '<div class="trophy">🏆</div>Congratulations! You have mastered CPR techniques!';
            feedbackMessage.style.color = 'var(--success)';
            nextLevelActions.style.display = 'none';
        } else {
            feedbackMessage.textContent = `Excellent! You've passed Level ${currentLevel}!`;
            feedbackMessage.style.color = 'var(--success)';
            nextLevelActions.style.display = 'block';
        }
    } else {
        feedbackMessage.textContent = `You need ${levelThreshold}% to pass Level ${currentLevel}. Keep practicing!`;
        feedbackMessage.style.color = 'var(--warning)';
        nextLevelActions.style.display = 'none';
    }
    
    resultsCircle.style.background = `conic-gradient(var(--primary) ${overall}%, transparent ${overall}%)`;
    
    resultsScreen.classList.remove('hide');
}

// Enhanced end game function with high score tracking
function enhancedEndGame() {
    // First run the original endGame logic
    endGame();
    
    // Then check for high scores
    const overall = parseInt(overallScore.textContent);
    const isHighScore = saveHighScore(currentLevel, overall);
    
    // Display high score notification if applicable
    if (isHighScore) {
        const highScoreNotice = document.createElement('div');
        highScoreNotice.textContent = '🏆 NEW HIGH SCORE! 🏆';
        highScoreNotice.style.color = 'gold';
        highScoreNotice.style.fontWeight = 'bold';
        highScoreNotice.style.fontSize = '1.2rem';
        highScoreNotice.style.marginTop = '10px';
        
        feedbackMessage.parentNode.insertBefore(highScoreNotice, feedbackMessage.nextSibling);
        
        // Play success sound
        if (successSound) successSound();
    }
}

// Go to the next level
function goToNextLevel() {
    if (currentLevel < 3) {
        currentLevel++;
        updateLevelProgress();
        resultsScreen.classList.add('hide');
        showLevelIntro();
    }
}

// Restart the current level
function restartLevel() {
    resultsScreen.classList.add('hide');
    showLevelIntro();
}

// Go back to the start screen
function backToStart() {
    resultsScreen.classList.add('hide');
    startScreen.classList.remove('hide');
}

// Update the level progress indicators
function updateLevelProgress() {
    levelSteps.forEach(step => {
        const stepLevel = parseInt(step.dataset.level);
        
        step.classList.remove('completed', 'current');
        
        if (stepLevel < currentLevel) {
            step.classList.add('completed');
        } else if (stepLevel === currentLevel) {
            step.classList.add('current');
        }
    });
}

// Handle compression action
function handleCompression() {
    if (!gameActive || gameMode !== 'compressions') return;
    
    // Play compression sound
    if (compressionSound) compressionSound();
    
    const now = Date.now();
    
    if (lastCompressionTime > 0) {
        const timeDiff = now - lastCompressionTime;
        compressionTimes.push(timeDiff);
        
        if (compressionTimes.length > 10) {
            compressionTimes.shift();
        }
        
        if (compressionCount % 3 === 0 || compressionCount === 30) {
            const rate = calculateCurrentCompressionRate();
            compressionRateDisplay.textContent = `${rate}/min`;
            
            provideFeedback(compressionFeedback, rate);
        }
    }
    
    lastCompressionTime = now;
    
    compressionCount++;
    compressionCountDisplay.textContent = `${compressionCount}/30`;
    
    compressionIcon.classList.add('active');
    setTimeout(() => {
        compressionIcon.classList.remove('active');
    }, 100);
    
    if (compressionCount >= 30) {
        gameMode = 'ventilations';
        compressionCount = 0;
        ventilationCount = 0;
        compressionCountDisplay.textContent = `0/30`;
        updateCycleIndicator();
    }
}

// Start ventilation
function startVentilation(e) {
    if (e) e.preventDefault();
    
    if (!gameActive || gameMode !== 'ventilations') return;
    
    // Play ventilation start sound
    if (ventilationSound) ventilationSound();
    
    ventilationStartTime = Date.now();
    ventilationIcon.classList.add('active');
}

// End ventilation
function endVentilation() {
    if (!gameActive || gameMode !== 'ventilations' || !ventilationStartTime) return;
    
    const ventilationTime = (Date.now() - ventilationStartTime) / 1000;
    ventilationHoldTimes.push(ventilationTime);
    
    if (ventilationHoldTimes.length > 6) {
        ventilationHoldTimes.shift();
    }
    
    ventilationTimeDisplay.textContent = `${ventilationTime.toFixed(1)}s`;
    
    provideFeedbackVentilation(ventilationFeedback, ventilationTime);
    
    ventilationIcon.classList.remove('active');
    
    ventilationStartTime = 0;
    
    ventilationCount++;
    
    if (ventilationCount >= 2) {
        gameMode = 'compressions';
        cycleCount++;
        compressionRateDisplay.textContent = `0/min`;
        updateCycleIndicator();
    }
}

// Update the cycle indicator
function updateCycleIndicator() {
    cycleSteps.forEach(step => {
        step.classList.remove('active');
    });
    
    const activeStep = gameMode === 'compressions' ? 0 : 1;
    cycleSteps[activeStep].classList.add('active');
}

// Provide feedback for compression rate
function provideFeedback(element, rate) {
    let message, className;
    let targetRate = 105;
    let tolerance = 5;
    
    if (currentLevel === 2) {
        tolerance = 3;
    } else if (currentLevel === 3) {
        tolerance = 1;
    }
    
    if (Math.abs(rate - targetRate) <= tolerance / 5) {
        message = "Perfect!";
        className = "good";
    } else if (Math.abs(rate - targetRate) <= tolerance) {
        message = "Good";
        className = "warning";
    } else {
        message = rate < targetRate ? "Too Slow" : "Too Fast";
        className = "bad";
    }
    
    element.textContent = message;
    element.className = "feedback " + className + " visible";
    
    setTimeout(() => {
        element.classList.remove("visible");
    }, 1000);
}

// Provide feedback for ventilation time
function provideFeedbackVentilation(element, time) {
    let message, className;
    let targetTime = 1;
    let tolerance = 0.15;
    
    if (currentLevel === 2) {
        tolerance = 0.1;
    } else if (currentLevel === 3) {
        tolerance = 0.05;
    }
    
    if (Math.abs(time - targetTime) <= tolerance / 3) {
        message = "Perfect!";
        className = "good";
    } else if (Math.abs(time - targetTime) <= tolerance) {
        message = "Good";
        className = "warning";
    } else {
        message = time < targetTime ? "Too Short" : "Too Long";
        className = "bad";
    }
    
    element.textContent = message;
    element.className = "feedback " + className + " visible";
    
    setTimeout(() => {
        element.classList.remove("visible");
    }, 1000);
}

// Calculate the current compression rate
function calculateCurrentCompressionRate() {
    if (compressionTimes.length === 0) return 0;
    
    const avgTime = compressionTimes.reduce((sum, time) => sum + time, 0) / compressionTimes.length;
    return Math.round(60000 / avgTime);
}

// Calculate the average compression rate
function calculateAverageCompressionRate() {
    if (compressionTimes.length === 0) return 0;
    
    const avgTime = compressionTimes.reduce((sum, time) => sum + time, 0) / compressionTimes.length;
    return Math.round(60000 / avgTime);
}

// Calculate the average ventilation time
function calculateAverageVentilationTime() {
    if (ventilationHoldTimes.length === 0) return 0;
    
    return ventilationHoldTimes.reduce((sum, time) => sum + time, 0) / ventilationHoldTimes.length;
}

// Calculate the compression rate score
function calculateCompressionRateScore() {
    const rate = calculateAverageCompressionRate();
    const targetRate = 105;
    
    // Calculate deviation from target rate
    const deviation = Math.abs(rate - targetRate);
    
    // Deduct 2% per unit of deviation
    const deduction = deviation * 2;
    
    // Maximum score is 50%, minimum is 0%
    const score = Math.max(50 - deduction, 0);
    
    return score;
}

// Calculate the ventilation time score
function calculateVentilationTimeScore() {
    const avgTime = calculateAverageVentilationTime();
    const targetTime = 1.0;
    
    // Calculate deviation from target time in hundredths of a second
    const deviationInHundredths = Math.abs(avgTime - targetTime) * 100;
    
    // Deduct 1% per 0.01s deviation
    const deduction = deviationInHundredths;
    
    // Maximum score is 50%, minimum is 0%
    const score = Math.max(50 - deduction, 0);
    
    return score;
}

// Toggle pause/resume game
function togglePause() {
    if (!gameActive) return;
    
    if (isPaused) {
        // Resume game
        isPaused = false;
        gameActive = true;
        
        // Restore timer
        secondsRemaining = pausedRemainingTime;
        
        // Restart the timer interval
        gameInterval = setInterval(() => {
            secondsRemaining--;
            
            const minutes = Math.floor(secondsRemaining / 60);
            const seconds = secondsRemaining % 60;
            timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            const progressPercent = ((60 - secondsRemaining) / 60) * 100;
            document.querySelector('.timer').style.background = 
                `conic-gradient(var(--primary) ${progressPercent}%, transparent ${progressPercent}%)`;
            
            progressBar.style.width = `${progressPercent}%`;
            
            if (secondsRemaining <= 0) {
                enhancedEndGame();
            }
        }, 1000);
    } else {
        // Pause game
        isPaused = true;
        gameActive = false;
        
        // Store current time
        pausedRemainingTime = secondsRemaining;
        
        // Clear interval
        clearInterval(gameInterval);
        
        // Display pause indicator
        timeDisplay.textContent = "⏸️";
    }
}

// Add keyboard controls for accessibility
function addKeyboardControls() {
    document.addEventListener('keydown', (e) => {
        if (!gameActive) return;
        
        // Space for compression
        if (e.code === 'Space' && gameMode === 'compressions') {
            e.preventDefault();
            handleCompression();
        }
        
        // Enter for ventilation
        if (e.code === 'Enter' && gameMode === 'ventilations') {
            e.preventDefault();
            if (!ventilationStartTime) {
                startVentilation(e);
            }
        }
    });
    
    document.addEventListener('keyup', (e) => {
        if (!gameActive) return;
        
        // Enter for ventilation end
        if (e.code === 'Enter' && gameMode === 'ventilations' && ventilationStartTime) {
            e.preventDefault();
            endVentilation();
        }
    });
}

// Initialize audio for sound effects
function initAudio() {
    try {
        window.AudioContext = window.AudioContext || window.webkitAudioContext;
        audioContext = new AudioContext();
        
        // Create simple sounds
        compressionSound = createSound(200, 0.1);
        ventilationSound = createSound(300, 0.2);
        successSound = createSuccessSound();
        failSound = createFailSound();
    } catch (e) {
        console.log('Web Audio API not supported.');
    }
}

// Create a basic sound effect
function createSound(frequency, duration) {
    return function() {
        if (!audioContext) return;
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        gainNode.gain.value = 0.2;
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + duration);
    };
}

// Create a success sound effect
function createSuccessSound() {
    return function() {
        if (!audioContext) return;
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.type = 'sine';
        
        // Play an ascending arpeggio
        gainNode.gain.value = 0.2;
        
        oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
        oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
        oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
        
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.5);
    };
}

// Create a fail sound effect
function createFailSound() {
    return function() {
        if (!audioContext) return;
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.type = 'sine';
        
        // Play a descending tone
        gainNode.gain.value = 0.2;
        
        oscillator.frequency.setValueAtTime(400, audioContext.currentTime);
        oscillator.frequency.setValueAtTime(300, audioContext.currentTime + 0.1);
        
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.3);
        
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.3);
    };
}

// Load high scores from localStorage
function loadHighScores() {
    const storedScores = localStorage.getItem('cprGameHighScores');
    if (storedScores) {
        highScores = JSON.parse(storedScores);
    }
}

// Save high scores to localStorage
function saveHighScore(level, score) {
    const levelKey = `level${level}`;
    if (score > highScores[levelKey]) {
        highScores[levelKey] = score;
        localStorage.setItem('cprGameHighScores', JSON.stringify(highScores));
        return true; // Return true if this is a new high score
    }
    return false;
}

// Initialize the game when the window loads
window.addEventListener('load', initGame);
</script>       